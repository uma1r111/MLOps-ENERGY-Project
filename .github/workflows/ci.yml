name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:

env:
  PYTHON_VERSION: '3.10'
  IMAGE_NAME: ghcr.io/${{ github.repository }}
  COVERAGE_THRESHOLD: 80

jobs:
  # ---------- 1️⃣ Lint Job ----------
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Linters
        run: |
          pip install ruff black

      - name: Run Ruff
        run: ruff check .

      - name: Run Black Check
        run: black --check .

  # ---------- 2️⃣ Test Job ----------
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run Tests with Coverage
        run: |
          pytest --cov=. --cov-report=term-missing --cov-fail-under=${{ env.COVERAGE_THRESHOLD }}

  # ---------- 3️⃣ Build & Push Docker Image ----------
  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build Docker Image
        run: docker build -t ${{ env.IMAGE_NAME }}:${{ github.sha }} -f tests/Dockerfile.test .

      - name: Push Docker Image
        run: docker push ${{ env.IMAGE_NAME }}:${{ github.sha }}

  # ---------- 4️⃣ Canary Deployment ----------
  canary-deploy:
    name: Canary Deployment
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Run Canary Container
        run: |
          docker run -d --rm \
            -e CANARY=true \
            -p 8080:8080 \
            ${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Wait for Canary to Start
        run: sleep 30

  # ---------- 5️⃣ Acceptance Tests ----------
  acceptance-tests:
    name: Acceptance Tests (Golden Set)
    runs-on: ubuntu-latest
    needs: canary-deploy
    steps:
      - name: Hit Canary Endpoint
        run: |
          echo "Running golden set checks..."
          for url in \
            "http://localhost:8080/api/health" \
            "http://localhost:8080/api/status" \
            "http://localhost:8080/api/version" \
            "http://localhost:8080/api/predict?x=5" \
            "http://localhost:8080/api/predict?x=10"; do
              echo "Testing $url"
              status=$(curl -s -o /dev/null -w "%{http_code}" "$url")
              if [ "$status" != "200" ]; then
                echo "❌ $url failed with status $status"
                exit 1
              fi
            done
          echo "✅ All golden set tests passed!"
